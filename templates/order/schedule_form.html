<div id="schedule-content">
</div>
<a href="#" id="schedule-add" class="btn btn-default"><span class="glyphicon glyphicon-plus"></span> 排期项</a>
<a href="#" id="form-submit" class="btn btn-primary btn-sm col-md-offset-2" >提交</a>
<style>
    th {text-align: center;}
    .sch-date {text-align: center;}
    .sch-num {text-align: center;}
    .sch-num input{display: inline-block; width: 50px; text-align: right;}
</style>

<script type="txt/template" id="schedule-tpl">
<div class="well schedule-form">
  <div class="form-group">
    <label for="sale_type" class="col-md-2 control-label">售卖类型: </label>
    <div class="col-md-4">
      <select class="sale_type form-control" name="sale_type">
        {% for (k, v) in SALE_TYPE_CN.items() %}
            <option value="{{k}}">{{v}}</option>
        {% endfor %}
      </select>
    </div>
    <label for="sale_type" class="col-md-2 control-label">特殊/定向: </label>
    <div class="col-md-4">
      <select class="special_sale form-control" name="special_sale">
        {% for (k, v) in SPECIAL_SALE_CN.items() %}
            <option value="{{k}}">{{v}}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="form-group">
    <label for="position" class="col-md-2 control-label">展示位置: </label>
    <div class="col-md-4">
      <select class="position form-control" name="position">
        {% for (k, v) in positions %}
            <option value="{{k}}">{{v}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 col-md-offset-2">
        <a href="#" class="schedule-load btn btn-default">查看可预订资源</a>
    </div>
  </div>
 <div class="form-group">
    <table class="table table-striped table-bordered" id="schedule-table">
    </table>
  </div>
</div>
</script>
<script>
$(document).ready(function(){
    $("#schedule-add").click(function(){
      var schedule_tpl = $("#schedule-tpl").html(); 
      $("#schedule-content").append(schedule_tpl);
    });
    $('.datetimepicker').datetimepicker({
        autoclose: true,
        todayHighlight: true,
        language: 'zh-CN',
        minView: 2
      });
    function schedule_td(schedule){
        var weekday = schedule[2];
        if((schedule[1])>0){
          var td = '<td class="weekday-'+weekday+'"><div class="sch-date">' + 
            schedule[0] + 
            '</div><div class="sch-num"><input type="text" class="order-num" name="' + schedule[0] +
            '" value="0"/>' + ' / '+ schedule[1] +'</div></td>';
        }
        else{
          var td = '<td><div class="sch-date">' + schedule[0] + '</div><div class="sch-num">无资源</div></td>';
        }
        if(weekday == 1){ td = '<tr>' + td; }
        if(weekday == 7){ td = td + '</tr>';}
        return td;
    }
    function schedule_header(schedule){
        var _content = '<tr> <th>周一</th> <th>周二</th> <th>周三</th> <th>周四</th> <th>周五</th> <th>周六</th> <th>周日</th></tr>',
        weekday = schedule[2];
        if(weekday > 1){
          _content = _content + '<tr>';
          for(var i=1; i < weekday; i++ )
          {
              _content = _content + '<td></td>';
          }
        }
        return _content;
    }
    function load_schedule(position){
      var start = $("#start_date").val(),
      end = $("#end_date").val();
      $.getJSON('{{url_for("order.schedule_info")}}?start='+start+'&end='+end+'&position='+position.val(),
          function(result){
            table_content = schedule_header(result['schedules'][0]);
            for(var x in result['schedules']){
                table_content = table_content + schedule_td(result['schedules'][x]);
            }
            position.parents(".schedule-form").find("#schedule-table").html(table_content);
          });
    }
    $("body").on('change', "select", function(){
      load_schedule($(this));
    });
    $("body").on('click', ".schedule-load", function(){
      load_schedule($(this).parents(".schedule-form").find(".position"));
    });
    function get_form_schedule_data(schedules){
      var ret = {};
      if(schedules.length > 0){
        for(var x=0; x<schedules.length; x++){
          var schedule = schedules[x];
          if($(schedule).val() > 0){
            ret[schedule.name] = $(schedule).val();
          }
        }
      }
      return ret;
    }
    function get_form_all_data(){
        var ret = [];
        if($(".schedule-form").length > 0){
          for(var x=0; x<$(".schedule-form").length; x++){
              var form = $(".schedule-form")[x],
              form_data = {};
              form_data['sale_type'] = $(form).find(".sale_type").val();
              form_data['special_sale'] = $(form).find(".special_sale").val();
              form_data['position'] = $(form).find(".position").val();
              form_data['schedule'] = get_form_schedule_data($(form).find(".order-num"));
              if(!$.isEmptyObject(form_data['schedule'])){ ret.push(form_data);}
          }
        }
        return ret;
    }
    function post_schedules(sent_data){
      if(sent_data.length==0){alert("所有排期项都为空!");}
      else{
        $.post('{{url_for("order.schedules_post", order_id=order.id)}}',
          {data: $.toJSON(sent_data)},
          function(data) {
            if(data['status'] == '0'){
              window.location.href = "{{url_for("order.order_detail", order_id=order.id)}}";
            }
            else{
              alert(data['msg']);
            }
          },
          'json'); 
      }
    }
    $("#form-submit").click(function(){
        if($(".schedule-form").length==0){alert("请先新建排期项!");}
        else{ post_schedules(get_form_all_data());}
    });

    //load_schedule($("#position").val(), $("#start_date").val(), $("#end_date").val());


/* 暂时保留, 后期会根据饿售卖类型和特殊售卖筛选展示位置*/
/*
    function load_position(sale_type, special_sale){
      $.getJSON('{{url_for("order.position_list")}}?order={{order.id}}&sale_type='+sale_type+'&special_sale='+special_sale,function(result){
        $("#position")[0].options.length = 0;
        for(var x in result){
            $("#position")[0].options.add(new Option(result[x], x));
        }
        $("#position_chosen").remove();
        $("#position").show();
        $("#position").chosen({placeholder_text:"请选择...", disable_search_threshold: 10});
        });
    } 
    $("#sale_type").change(function(){
      load_position($("#sale_type").val(), $("#special_sale").val());
    });
    $("#special_sale").change(function(){
      load_position($("#sale_type").val(), $("#special_sale").val());
    });
*/


});
</script>
