{% extends "/order_base.html" %}
{% block title %}订单列表{% endblock %}

{% macro other(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>客户</th>
        <th>Campaign</th>
        <th>直客销售</th>
        <th>渠道销售</th>
        <th>区域</th>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>投放媒体</th>
        <th>执行</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td style="width:160px;">{{o.client.name}}</td>
        <td style="width:160px;">{{o.campaign}}</td>
        <td>{{o.direct_sales_names}}</td>
        <td>{{o.agent_sales_names}}</td>
        <td>{{o.locations_cn}}</td>
        <td>{{o.start_date_cn}}</td>
        <td>{{o.end_date_cn}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.operater_names}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            <a href="{{o.info_path()}}">订单管理</a>
        </td>
 
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% macro operater(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>代理/直客</th>
        <th>客户</th>
        <th>Campaign</th>
        <th>合同金额</th>
        <th>直客销售</th>
        <th>渠道销售</th>
        <th>媒体</th>
        <th>金额</th>
        <th>开始</th>
        <th>结束</th>
        <th>执行</th>
        <th>排期</th>
        <th>合同号状态</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td style="width:160px;">{{o.agent.name}}</td>
        <td style="width:100px;">{{o.client.name}}</td>
        <td style="width:100px;">{{o.campaign}}</td>
        <td>{{o.money}}</td>
        <td>{{o.direct_sales_names}}</td>
        <td>{{o.agent_sales_names}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_money}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.start_date_cn}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.end_date_cn}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.operater_names}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            <a href="{{mo.path()}}">排期设置</a>
            <br><br>
            {% endfor %}
        </td>
        <td>{{o.contract_status_cn}}</td>
        <td>
            <a href="{{o.info_path()}}">订单管理</a>
            {% if g.user.is_super_admin() %}
            <a href="{{url_for("order.order_delete", order_id=o.id)}}" style="color:red;">删除</a>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% macro admin(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>代理/直客</th>
        <th>客户</th>
        <th>Campaign</th>
        <th>合同金额</th>
        <th>直客销售</th>
        <th>渠道销售</th>
        <th>区域</th>
        <th>媒体</th>
        <th>金额</th>
        <th>开始</th>
        <th>结束</th>
        <th>执行</th>
        <th>排期</th>
        <th>合同号状态</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td style="width:160px;">{{o.agent.name}}</td>
        <td style="width:100px;">{{o.client.name}}</td>
        <td style="width:100px;">{{o.campaign}}</td>
        <td>{{o.money}}</td>
        <td>{{o.direct_sales_names}}</td>
        <td>{{o.agent_sales_names}}</td>
        <td>{{o.locations_cn}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_money}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.start_date_cn}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.end_date_cn}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.operater_names}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            <a href="{{mo.path()}}">排期设置</a>
            <br><br>
            {% endfor %}
        </td>
        <td>{{o.contract_status_cn}}</td>
        <td>
            <a href="{{o.info_path()}}">订单管理</a>
            {% if g.user.is_super_admin() %}
            <a href="{{url_for("order.order_delete", order_id=o.id)}}" style="color:red;">删除</a>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% macro contract(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>代理/直客</th>
        <th>客户</th>
        <th>Campaign</th>
        <th>合同金额</th>
        <th>直客销售</th>
        <th>渠道销售</th>
        <th>区域</th>
        <th>售卖类型</th>
        <th>合同号</th>
        <th>媒体订单</th>
        <th>下单金额</th>
        <th>合同号</th>
        <th>预估ECPM</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td>{{o.agent.name}}</td>
        <td>{{o.client.name}}</td>
        <td style="width:160px;">{{o.campaign}}</td>
        <td>{{o.money}}</td>
        <td>{{o.direct_sales_names}}</td>
        <td>{{o.agent_sales_names}}</td>
        <td>{{o.locations_cn}}</td>
        <td>{{o.resource_type_cn}}</td>
        <td>{{o.contract or "无合同号"}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_money}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_contract or "无合同号"}} 
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{"%.1f" % (mo.medium_money / mo.sale_CPM) if mo.sale_CPM else "无预估"}}
            <br><br>
            {% endfor %}
        </td>
        <td><a href="{{o.info_path()}}">合同设置</a></td>
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% macro sales(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>代理/直客</th>
        <th>客户</th>
        <th>Campaign</th>
        <th>合同金额</th>
        <th>回款日期</th>
        <th>媒体订单</th>
        <th>下单金额</th>
        <th>预估ECPM</th>
        <th>开始日期</th>
        <th>合同号状态</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td style="width:120px;">{{o.agent.name}}</td>
        <td style="width:120px;">{{o.client.name}}</td>
        <td style="width:160px;">{{o.campaign}}</td>
        <td>{{o.money}}</td>
        <td style="width:100px;">{{o.reminde_date_cn}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_money}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{"%.1f" % (mo.medium_money / mo.sale_CPM) if mo.sale_CPM else "无预估"}}
            <br><br>
            {% endfor %}
        </td>
        <td style="width:100px;">
            {% for mo in o.medium_orders %}    
            {{mo.start_date_cn}} 
            <br><br>
            {% endfor %}
        </td>
        <td>{{o.contract_status_cn}}</td>
        <td>
            <a href="{{o.info_path()}}">订单管理</a>
        </td>
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% macro leader(orders) -%}
<table class="table table-bordered table-striped">
    <tr>
        <th>代理/直客</th>
        <th>客户</th>
        <th>Campaign</th>
        <th>合同金额</th>
        <th>回款日期</th>
        <th>直客销售</th>
        <th>渠道销售</th>
        <th>区域</th>
        <th>直签/代理</th>
        <th>媒体订单</th>
        <th>下单金额</th>
        <th>预估ECPM</th>
        <th>合同号状态</th>
        <th>操作</th>
    </tr>
    {% for o in orders %}
    <tr>
        <td style="width:120px;">{{o.agent.name}}</td>
        <td style="width:120px;">{{o.client.name}}</td>
        <td style="width:120px;">{{o.campaign}}</td>
        <td>{{o.money}}</td>
        <td>{{o.reminde_date_cn}}</td>
        <td>{{o.direct_sales_names}}</td>
        <td>{{o.agent_sales_names}}</td>
        <td>{{o.locations_cn}}</td>
        <td>{{o.sale_type_cn}}</td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium.name}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{mo.medium_money}}
            <br><br>
            {% endfor %}
        </td>
        <td>
            {% for mo in o.medium_orders %}    
            {{"%.1f" % (mo.medium_money / mo.sale_CPM) if mo.sale_CPM else "无预估"}}
            <br><br>
            {% endfor %}
        </td>
        <td>{{o.contract_status_cn}}</td>
        <td style="width:60px;">
            <a href="{{o.info_path()}}">审批</a>
        </td>
    </tr>
    {% endfor %}
</table>
{%- endmacro %}

{% block main_box %}
<div class="bra-main bra-box">
    <h3> {{title}}</h3>
    <div class="search">
        <input class="col-md-3" type="text" id="search_info" value="{{search_info}}" placeholder="客户/代理/媒体/合同号/Campaign" onkeypress="javascript:enter_search();">&nbsp;
        <select class="col-md-2" id="search_location" name="location" placeholder="区域">
            {% for v, m in locations %}
                {% if v == location_id|int %}
                <option selected="" value="{{v}}">{{m}}</option>
                {% else %}
                <option value="{{v}}">{{m}}</option>
                {% endif %}
            {% endfor %}
        </select>
        <select class="col-md-2" id="search_status" name="status" placeholder="合同状态">
            {% for v, m in statuses %}
                {% if v == status_id|int %}
                <option selected="" value="{{v}}">{{m}}</option>
                {% else %}
                <option value="{{v}}">{{m}}</option>
                {% endif %}
            {% endfor %}
        </select>
        <input type="button" name="search" value="搜索" class="btn btn-sm btn-default" onclick="javascript:search();">
    </div>
    <br>
    {% if g.user.is_admin() %}
        {{ contract(orders) }}
    {% elif g.user.is_operater() %}
        {{ operater(orders) }}
    {% elif g.user.is_contract() %}
        {{ contract(orders) }}
    {% elif g.user.is_sale() %}
        {{ sales(orders) }}
    {% elif g.user.is_media() %}
        {{ contract(orders) }}
    {% elif g.user.is_leader() %}
        {{ leader(orders) }}
    {% else %}
        {{ other(orders) }}
    {% endif %}
    <nav>
      <ul class="pagination">
        {% if page-1 > 0 %}
        <li><a href="?p={{page-1}}">&laquo;</a></li>
        {% endif %}
        {% if page-2 > 0 %}
        <li class=""><a href="?p={{page-2}}">{{page-2}}</a></li>
        {% endif %}
        {% if page-1 > 0 %}
        <li class=""><a href="?p={{page-1}}">{{page-1}}</a></li>
        {% endif %}
        <li class="active disable"><a href="#">{{page}}</a></li>
        <li class=""><a href="?p={{page+1}}">{{page+1}}</a></li>
        <li class=""><a href="?p={{page+2}}">{{page+2}}</a></li>
        <li><a href="?p={{page+1}}">&raquo;</a></li>
      </ul>
    </nav>
</div>
<script>
function sort(value){
    var orderby = '{{orderby}}',
        sortby = '{{sortby}}';
    if (value == sortby) {
        if (orderby == 'desc'){
            orderby = 'asc'
        } else {
            orderby = 'desc'
        }
    } else {
        sortby = value
        orderby = 'desc'
    }
    window.location.href = window.location.pathname+'?sortby='+sortby+'&orderby='+orderby+
    '&searchinfo='+encodeURIComponent($('#search_info').val())+
    '&selected_location='+encodeURIComponent($('#search_location').val())+
    '&selected_status='+encodeURIComponent($('#search_status').val());
}

function search(){
    window.location.href = window.location.pathname +
      '?searchinfo=' + encodeURIComponent($('#search_info').val()) +
      '&selected_location=' + ($('#search_location').val()) +
      '&selected_status=' + ($('#search_status').val());
}

function enter_search(){
    //按下‘Enter’键
    if(event.keyCode == 13){
        search();
    }
}
</script>

{% endblock %}
