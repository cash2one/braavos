{% set ACTION_ACTIVE = 6 %}
{% set ACTION_PAUSE = 7 %}
{% macro items_tab_content(items_info, ordered=False) -%}
<div class="table-container">
  <table class="table table-bordered table-striped table-condensed text-center"]>
    <thead>
      <tr>
        <th rowspan="2" style="min-width: 40px;">售卖类型</th>
 	  {% if ordered == False %}
        <th rowspan="2" style="min-width: 40px;" class="text-center">
          <input type="checkbox" class="checkbox_all">
        </th>
           {% endif %}
        <th rowspan="2" style="min-width: 80px;">展示位置</th>
        {% for m, m_len in items_info['months'].items() %}
        <th colspan="{{m_len}}" class="text-center">{{m}} 月</th>
        {% endfor %}
        <th rowspan="2">总预订量</th>
        <th rowspan="2" style="min-width: 40px;">刊例单价</th>
      </tr>
      <tr>
        {% for d in items_info['dates'] %}
        {% if d.isoweekday() in [6, 7] %}
        <td class="bg-success">{{d.day}}</td>
        {% else %}
        <td class="bg-info">{{d.day}}</td>
        {% endif %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for v, sale_type_cn, sale_type_items in items_info['items'] %}
      {% for i in sale_type_items %}
      <tr>
        {% if loop.index == 1 %}
        <td rowspan="{{sale_type_items|length}}" style="vertical-align: middle;">{{sale_type_cn}}</td>
        {% endif %}
        {% if ordered == False %}
        <td>
          <input type="checkbox" class="checkbox_one" name="item_id" value="{{i.id}}">
        </td>
        {% endif %}
        {% if i.is_status_on() %}
        <td>
        {% else %}
        <td style="background: #f2dede">
        {% endif %}
          <a href="{{url_for('order.item_detail', item_id=i.id)}}">{{i.position.name}}</a>
        </td>
        {% for d in items_info['dates'] %}
        <th>{{i.schedule_by_date(d).num}}</th>
        {% endfor %}
        <td>{{i.schedule_sum}}</td>
        <td>{{i.position.price}}</td>
      </tr>
      {% endfor %}
      {% endfor %}
    </tbody>
  </table>
</div>
{%- endmacro %}



{% macro button_by_action(order, action) -%}
{% if order.can_action(g.user, action) %}
  <button class="btn btn-sm btn-primary" type="submit" name="action" value="{{action}}">{{action | item_status_action_cn}}</button>
{% endif %}
{%- endmacro %}

{% macro button_export_schedule(order) -%}
 <a class="btn-sm btn-primary button-export" href="{{ url_for('order.export_schedule', order_id=order.id) }}" name="export_schedule">导出排期</a>
{%- endmacro %}

{% macro leader_select(step, leaders) -%}
<div class="form-group">
        <label for="name" class="col-sm-2-1 control-label">Leader : </label>
        <div class="col-sm-5">
            <select class="form-control bra-form-control" id="leader{{step}}" multiple="" name="leader" placeholder="Leader">
              {% for (k,m) in leaders %}
              <option value="{{k}}">{{m}}</option>
              {% endfor %}
              </select>
        </div>
  </div>
{%- endmacro %}

{% macro order_items(order, step, leaders) -%}
<ul class="nav nav-pills" role="tablist">
  <li role="presentation" class="active"><a id="0" href="#tab-0" role="tab" data-toggle="tab">未下单</a></li>
  <li role="presentation"><a id="1" href="#tab-1" role="tab" data-toggle="tab">预下单(待审核)</a></li>
  <li role="presentation"><a id="2" href="#tab-2" role="tab" data-toggle="tab">预下单(通过)</a></li>
  <li role="presentation"><a id="3" href="#tab-3" role="tab" data-toggle="tab">下单(待审核)</a></li>
  <li role="presentation"><a id="4" href="#tab-4" role="tab" data-toggle="tab">已下单</a></li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade in active" id="tab-0">
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=0)}}" method="POST">
      {{ items_tab_content(order.items_info_by_status(0)) }}
      <div class="col_change_state_button">
        {{ leader_select(0, leaders) }}
        {{ button_by_action(order, 0) }}
      </div>
    </form>
  </div>
  <div class="tab-pane fade" id="tab-1">
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=1)}}" method="POST">
      {{ items_tab_content(order.items_info_by_status(1)) }}
      <div class="col_change_state_button">
        {{ button_by_action(order, 1) }}
        {{ button_by_action(order, 2) }}
      </div>
    </form>
  </div>
  <div class="tab-pane fade" id="tab-2">
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=2)}}" method="POST">
      {{ items_tab_content(order.items_info_by_status(2)) }}
      <div class="col_change_state_button">
        {{ leader_select(3, leaders) }}
        {{ button_by_action(order, 3) }}
      </div>
    </form>
  </div>
  <div class="tab-pane fade" id="tab-3">
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=3)}}" method="POST">
      {{ items_tab_content(order.items_info_by_status(3)) }}
      <div class="col_change_state_button">
        {{ button_by_action(order, 4) }}
        {{ button_by_action(order, 5) }}
      </div>
    </form>
  </div>
  <div class="tab-pane fade" id="tab-4">
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=4)}}" method="POST">
      {{ items_tab_content(order.items_info_by_status(4),True) }}
      <div class="col_change_state_button">
      </div>
    </form>
  </div>
</div>
<style>
.tab-pane {padding-bottom: 15px; overflow-x:auto;overflow-y:hidden;overflow: visible;}
</style>
<script>
$(document).ready(function(){
    var step = "a#" + {{ step }};
    $(step).click();
});
</script>
{%- endmacro %}

{% macro ordered_items(order)-%}
<div>
    <form action="{{url_for('order.items_status_update', order_id=order.id, step=4)}}" method="POST">
      {{ items_order_content(order.items_info_by_status(4)) }}
	 <div class="col_change_state_button">
        {{ button_by_action(order, ACTION_ACTIVE) }}
        {{ button_by_action(order, ACTION_PAUSE) }}
</div>
    </form>
  </div>
{%- endmacro %}

{% macro items_order_content(items_info)-%}
<div>
<table class="table table-bordered table-striped">
   <thead>
     <tr >
       <td>售卖类型</td>
       <td>
         <input type="checkbox" class="checkbox_all"/>
       </td>
       <td>展示位置</td>
       <td>开始时间</td>
       <td>结束时间</td>
       <td>目标展示数</td>
       <td>已经展示数</td>
       <td>点击数</td>
       <td>CTR</td>
       <td>进度</td>
       <td>投放控制</td>
      </tr>
   <thead>
<tbody class="table table-bordered table-striped">
       {% for v, sale_type_cn, sale_type_items in items_info['items'] %}
       {% for i in sale_type_items %}
  <tr >
    <td>{{sale_type_cn}}</td>
    <td>
      <input type="checkbox" class="checkbox_one" name="item_id" value="{{i.id}}"/>
    </td>
	{% if i.is_status_on() %}
    <td>
        {% else %}
    <td style="background: #f2dede">
        {% endif %}
      <input type="button" id="{{i.id}}"  onclick="show_items_detail(this.id);" value="{{i.position.name}}"/>
    </td>
    <td>{{i.start_date}}</td>
    <td>{{i.end_date}}</td>
    <td>{{i.schedule_sum}}</td>
    <td>{{i.get_monitor_num_all()}}</td>
    <td>{{i.get_click_num_all()}}</td>
    <td>{{i.get_ctr(None)}}</td>
    <td>{{i.get_finshed_proper(None)}}</td>
    <td><a href="/orders/item/{{i.id}}">投放控制</a></td>
  </tr> {{  order_every_items_detail(i) }}
    {% endfor %}
    {% endfor %}
    </tbody>
</table>
</div>
<script>
  $(document).ready(function(){
    $("#collapseOne").collapse('hide');
    $("#collapseTwo").collapse('show');
});

  function show_items_detail(id){
    var tab1=document.getElementById("items_thead"+id);
    var tab2=document.getElementById("items_thead_content"+id);
    var tab3=document.getElementById("material_thead"+id);
    var tab4=document.getElementById("material_thead_content"+id);
    tab1.style.display=(tab1.style.display=="none"?"":"none");
    tab2.style.display=(tab2.style.display=="none"?"":"none");
    tab3.style.display=(tab3.style.display=="none"?"":"none");
    tab4.style.display=(tab4.style.display=="none"?"":"none");
}
</script>
{%- endmacro %}

{% macro order_every_items_detail(item)  -%}
<div>
  <tbody>
    <thead id="items_thead{{item.id}}" style="display: none">
      <tr>
        <td rowspan="2">日期</td>
        <td rowspan="2">状态</td>
        <td rowspan="2">目标展示数</td>
        <td rowspan="2">已经展示数</td>
        <td rowspan="2">点击数</td>
        <td rowspan="2">CTR</td>
        <td rowspan="2">进度</td>
      </tr>
    </thead>
    <thead id="items_thead_content{{item.id}}"style="display: none">
	{% for t in item.schedules %}
      <tr>
        <td>{{t.date}}</td>
	<td>{{item.item_state_cn}}</td>
        <td>{{t.num}}</td>
        <td>{{item.get_monitor_num(t.date)}}</td>
        <td>{{item.get_click_num(t.date)}}</td>
        <td>{{item.get_ctr(t.date)}}</td>
        <td>{{item.get_finshed_proper(t.date)}}</td>
      </tr>
        {% endfor %}
    </thead>
<thead id="material_thead{{item.id}}" style="display: none">
  <tr>
    <td rowspan="2">素材名称</td>
    <td rowspan="2">广告类型</td>
    <td rowspan="2">状态</td>
    <td rowspan="2">已展示数</td>
    <td rowspan="2">点击数</td>
    <td rowspan="2">CTR</td>
  </tr>
</thead>
<thead id="material_thead_content{{item.id}}"style="display: none">
	{%  for t in item.materials %}
  <tr>	
    <td>{{t.name}}</td>
    <td>{{t.type}}</td>
    <td>{{t.status}}</td>
    <td>{{item.get_monitor_num_all()}}</td>
    <td>{{item.get_click_num_all()}}</td>
    <td>{{item.get_ctr(None)}}</td>
  </tr>
	{% endfor %}
</thead>
</tbody>
</div>
{%- endmacro %}
