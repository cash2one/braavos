{% extends "/base.html" %}
{% block title %}{{title}}{% endblock %}
{% block content %}
<style type="text/css">  
.loading_img{  
    position: absolute;  
    top:50%;  
    left:45%;  
}  
</style>
{% include "/data_query/super_leader/super_leader_base.html" %}
<div style="width:100%; height:100%; z-index:9999;position: absolute;background-color: #000;opacity: 0.2; display:none;" id="loading">
    <img class="loading_img" src="/static/imgs/loading.gif"></div>
</div>
<div class="container bra-box" id="medium_box" style="width:1000px;">
    <ul class="nav nav-tabs">
      <li id="_client_order_"class=""><a href="{{url_for('data_query_super_leader_money.client_order')}}">新媒体订单</a></li>
      <li id="_douban_order_" class=""><a href="{{url_for('data_query_super_leader_money.douban_order')}}">直签豆瓣订单</a></li>
    </ul>
    <h3>{{title}}</h3>
    <form class="form-inline">
        <div class="form-group">
            <label for="exampleInputEmail2">查询时间</label>
            <select class="col-md-12" id="year" name="year" style="width:100px;">
                {% for k in range(5) %}
                <option value='{{2014+k}}'>{{2014+k}}年</option>
                {% endfor %}
            </select>
        </div>
        <a href="javascript:search();" class="btn btn-default">查询</a>
        <!--<input type="button" value="导出Excel" class="btn btn-sm btn-default" onclick="javascript:download();">-->
    </form>
    <br>
    <div id="container" style="min-height:400px;"></div>
    <div id="container_list">
        
    </div>
<div>
<script src="/static/js/highcharts/highcharts.js"></script>
<script src="/static/js/highcharts/themes/grid-light.js"></script>
<script src="/static/js/numeral.min.js"></script>
<script>
    $(document).ready(function(){
        var pathname = window.location.pathname;
        var path_name = pathname.split("/")
        $("#_" + path_name[4]+'_').addClass("active");
        Highcharts.getOptions().colors = Highcharts.map(Highcharts.getOptions().colors, function (color) {
            return {
                radialGradient: {
                    cx: 0.5,
                    cy: 0.3,
                    r: 0.7
                },
                stops: [
                    [0, color],
                    [1, Highcharts.Color(color).brighten(-0.3).get('rgb')] // darken
                ]
            };
        });
        Highcharts.setOptions({
            lang: {
                shortMonths: ['一月', '二月', '三月', '四月', '五月', '六月',  '七月', '八月', '九月', '十月', '十一月', '十二月']
                
            }
        });
        Highcharts.createElement('link', {
           href: '//fonts.googleapis.com/css?family=Dosis:400,600',
           rel: 'stylesheet',
           type: 'text/css'
        }, null, document.getElementsByTagName('head')[0]);

        Highcharts.theme = {
           colors: ["#7cb5ec", "#f7a35c", "#90ee7e", "#7798BF", "#aaeeee", "#ff0066", "#eeaaee",
              "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"],
           chart: {
              backgroundColor: null,
              style: {
                 fontFamily: "Dosis, sans-serif"
              }
           },
           title: {
              style: {
                 fontSize: '16px',
                 fontWeight: 'bold',
                 textTransform: 'uppercase'
              }
           },
           tooltip: {
              borderWidth: 0,
              backgroundColor: 'rgba(219,219,216,0.8)',
              shadow: false
           },
           legend: {
              itemStyle: {
                 fontWeight: 'bold',
                 fontSize: '13px'
              }
           },
           xAxis: {
              gridLineWidth: 1,
              labels: {
                 style: {
                    fontSize: '12px'
                 }
              }
           },
           yAxis: {
              minorTickInterval: 'auto',
              title: {
                 style: {
                    textTransform: 'uppercase'
                 }
              },
              labels: {
                 style: {
                    fontSize: '12px'
                 }
              }
           },
           plotOptions: {
              candlestick: {
                 lineColor: '#404048'
              }
           },


           // General
           background2: '#F0F0EA'

        };
        Highcharts.setOptions(Highcharts.theme);
        var now_date = new Date();
        var year = now_date.getFullYear();
        $('#year').val(year);
        $("#year").trigger("chosen:updated");
        search()
    })

    function search(){
        $('#loading').show()
        var year = parseInt($('#year').val());
        var type = '{{type}}';
        if (type == 'client'){
            var url = "{{url_for('data_query_super_leader_money.client_order_json')}}"
        }else{
            var url = "{{url_for('data_query_super_leader_money.douban_order_json')}}"
        }
        
        $.ajax({
            type: 'POST',
            url: url,
            data: {year: year},
            dataType: 'json',
            success: function(data, err){
                load_chart(data['title'], data['data'])
                //load_list_container(data['data'][0]['data'], data['total'])
                $('#loading').hide()
            }

        })
    }
    function load_list_container(data, total){
        $('#container_list').html('');
        var start_table = "<table class='table table-bordered'><thead><tr>\
                        <th>#</th><th>行业分类</th><th>执行额</th><th>占比</th></tr>\
                    </thead>\
                    <tbody>"
        var end_table = "</tbody></table>"
        var list_container_table = ""
        for(var i=0; i<data.length; i++){
            list_container_table += "<tr><th scope='row'>"+(i+1)+"</th><td>"+data[i]['name']+"</td><td>"+numeral(data[i]['y']).format('0,0.00')+"</td><td>"+numeral(data[i]["percent"]).format('0,0.00')+"%</td></tr>"
        }
        list_container_table += "<tr><th scope='row' colspan=2 style='text-align: center;'>总计</th><td>"+numeral(total).format('0,0.00')+"</td><td>100.00%</td></tr>"
        $('#container_list').html(start_table+list_container_table+end_table)
    }
    function load_chart(title, data) {    
        $('#container').highcharts({
            chart: {
                type: 'spline'
            },
            title: {
                text: title
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                type: 'datetime',
                dateTimeLabelFormats: { // don't display the dummy year
                    month: '%b',
                    year: '%b'
                },
                title: {
                    text: 'Date'
                }
            },
            yAxis: {
                title: {
                    text: '执行额 (元)'
                },
                min: 0
            },
            tooltip: {
                headerFormat: '<b>{series.name}</b><br>',
                pointFormat: '{point.x:%b}: {point.y:.2f}元'
            },

            plotOptions: {
                spline: {
                    marker: {
                        enabled: true
                    }
                }
            },

            series: data
        });
    };
    
</script>
{% endblock %}